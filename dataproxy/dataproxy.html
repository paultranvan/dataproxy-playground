
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DataProxy</title>
</head>
<body>
    <h1>DataProxy</h1>
    <p>Listening for messages...</p>

    <script>
        const USE_WORKER = false; // Set to true to use web workers, false otherwise
        const PROCESS_TIME = 500 // Simulate processing time (in milliseconds)
        const DOCS_SIZE = 1000 // Number of returned docs

        let startTime
        let endTime
        let endTime2

        // Create a simple JSON object array to simulate documents
        function generateDummyData(size) {
            const data = [];
            for (let i = 0; i < size; i++) {
                data.push({ id: i, title: `Document ${i}`, content: `This is document ${i}` });
            }
            return data;
        }

        function dataToBuffer(jsonData) {
            const jsonString = JSON.stringify(jsonData);
            const encoder = new TextEncoder();
            const arrayBuffer = encoder.encode(jsonString);
            return arrayBuffer.buffer; // Return the underlying buffer
        }

        // Message handler for incoming queries
        window.addEventListener('message', (event) => {
            if (event.origin != 'http://localhost:4000') {
                return
            }
            startTime = performance.now()
            console.log('[DATAPROXY] Received event : ', event)
            const origin = event.origin
            const { type, query, useTransfer = false } = event.data;
            console.log('[DATAPROXY] Received query : ', query)

            if (type === 'query') {
                if (USE_WORKER) {
                    // Use web worker for processing
                    runInWorker(query, origin, { useTransfer });
                } else {
                    // Run processing without worker
                    simulateProcessing(query, origin, { useTransfer });
                }
            }
            })

        // Simulate processing without web worker
        function simulateProcessing(query, origin, {useTransfer}) {
            setTimeout(() => {
                const data = generateDummyData(DOCS_SIZE);
                console.log('[DATAPROXY] post data : ', data)
                endTime2 = performance.now()
                console.log('[DATAPROXY] elapsed after processing : ', endTime2 - startTime);
                console.log('[DATAPROXY] PROCESS_TIME : ', PROCESS_TIME)
                if (useTransfer) {
                    const startTimeBUffer = performance.now()
                    const buffer = dataToBuffer(data)
                    const endTimeBUffer = performance.now()
                    console.log('[DATAPROXY] buffer elapsed : ', endTimeBUffer - startTimeBUffer)
                    window.parent.postMessage({ buffer, processTime: PROCESS_TIME }, origin, [buffer]);
                } else {
                    window.parent.postMessage({ docs: data, processTime: PROCESS_TIME }, origin);
                }
                
                endTime = performance.now()
                console.log('[DATAPROXY] elapsed after all postMessage response : ', endTime - startTime)

            }, PROCESS_TIME);
        }

        // Simulate processing with web worker
        function runInWorker(query, origin, {useTransfer}) {
            const worker = new Worker('./worker.js');
            worker.postMessage({ query, processTime: PROCESS_TIME, docsSize: DOCS_SIZE });
            
            worker.onmessage = function(event) {
                if (useTransfer) {
                    const startTimeBUffer = performance.now()
                    const buffer = dataToBuffer(event.data)
                    const endTimeBUffer = performance.now()
                    console.log('[DATAPROXY] buffer elapsed : ', endTimeBUffer - startTimeBUffer)
                    window.parent.postMessage({ buffer, processTime: PROCESS_TIME }, origin, [buffer]);
                } else {
                    window.parent.postMessage({ docs: event.data, processTime: PROCESS_TIME }, origin);

                }
                worker.terminate(); // Terminate worker after job is done
            };
        }
    </script>
</body>
</html>
